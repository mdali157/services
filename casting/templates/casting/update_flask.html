{% extends 'base_template.html' %}
{% load static %}

{% block head %}
<link href="{% static 'css/receiving-styles.css' %}" rel="stylesheet" />
{% endblock %}

{% block content %}
<form method="post" action="{% url 'casting:update_flask' flask.id %}">
    {% csrf_token %}
    <div class="container-fluid my-4">
        <h3>Update Flask</h3>

        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Flask No</label>
                <input type="text" class="form-control" value="{{ flask.id }}" disabled />
            </div>
            <div class="col-md-3">
                <label class="form-label">Karate</label>
                <input type="text" id="karate" name="karate" class="form-control" required value="{{ flask.karate }}" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Color</label>
                <input type="text" name="color" class="form-control" required value="{{ flask.color }}" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Date</label>
                <input type="date" name="creation_date" class="form-control" value="{{ flask.created_at|date:'Y-m-d' }}" required />
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">Input Weight</label>
                <input type="number" step="0.01" name="input_weight" id="input_weight" class="form-control" value="{{ flask.input_weight }}" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Output Weight</label>
                <input type="number" step="0.01" name="output_weight" id="output_weight" class="form-control" value="{{ flask.output_weight }}" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Machine Wastage</label>
                <input type="number" step="0.01" name="machine_wastage" id="machine_wastage" class="form-control" value="{{ flask.machine_wastage }}" readonly />
            </div>
            <div class="col-md-3">
                <label class="form-label">Production Weight</label>
                <input type="number" step="0.01" name="production_weight" class="form-control" value="{{ flask.production_weight }}" required />
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-label">Add New Castings</label>
                <select class="form-control select2" id="related_castings" name="related_castings" multiple>
                    {% for casting in unlinked_castings %}
                        <option value="{{ casting.id }}">{{ casting.casting_no }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <h5>Castings</h5>
                <table class="table table-bordered" id="casting-details-table">
                    <thead>
                        <tr>
                            <th>Casting S-No</th>
                            <th>Weight</th>
                            <th>Converted 24K</th>
                            <th>Wastage %</th>
                            <th>Wastage Weight</th>
                            <th>Total Weight 24K</th>
                            <th>Gold Received</th>
                            <th>Services Rate</th>
                            <th>Services Amount</th>
                            <th>Cash Received</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for casting in existing_castings %}
                        <tr data-casting-id="{{ casting.id }}" class="existing-row">
                            <td><input type="text" class="form-control" value="{{ casting.casting_no }}" readonly></td>
                            <td><input type="text" name="casting_{{ casting.id }}_weight" value="{{ casting.weight }}" class="form-control"></td>
                            <td><input type="text" name="casting_{{ casting.id }}_converted" value="{{ casting.converted24k }}" class="form-control"></td>
                            <td><input type="text" name="casting_{{ casting.id }}_wastage_percent" value="{{ casting.wastage_percentage }}" class="form-control"></td>
                            <td><input type="text" name="casting_{{ casting.id }}_wastage_weight" value="{{ casting.wastage_weight }}" class="form-control"></td>
                            <td>
                                <input type="text" name="casting_{{ casting.id }}_total_24k" value="{{ casting.total_weight24k }}" class="form-control" readonly>
                            </td>
                            <td><input type="text" name="casting_{{ casting.id }}_gold_received" value="{{ casting.gold_received }}" class="form-control"></td>
                            <td><input type="text" name="casting_{{ casting.id }}_service_rate" value="{{ casting.service_charges_rate }}" class="form-control"></td>
                            <td><input type="text" name="casting_{{ casting.id }}_service_amount" value="{{ casting.service_charges_amount }}" class="form-control"></td>
                            <td><input type="text" name="casting_{{ casting.id }}_cash_received" value="{{ casting.cash_received }}" class="form-control"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-primary">
                <i class="fa fa-save"></i> Update Flask
            </button>
        </div>
    </div>
</form>
{% endblock %}

{% block scripts %}
<script>
    // Wastage calc
    document.getElementById('input_weight').addEventListener('input', calcWastage);
    document.getElementById('output_weight').addEventListener('input', calcWastage);

    function calcWastage() {
        let inp = parseFloat(document.getElementById('input_weight').value) || 0;
        let out = parseFloat(document.getElementById('output_weight').value) || 0;
        document.getElementById('machine_wastage').value = (inp - out).toFixed(2);
    }

    // Recalculate rows on input
    function bindRowEvents(row) {
        const inputs = row.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', () => recalculateRow(row));
        });
    }

    function recalculateRow(row) {
        const karate = parseFloat(document.getElementById('karate').value) || 0;
        const weight = parseFloat(row.querySelector(`[name$="_weight"]`).value) || 0;
        const wastagePercent = parseFloat(row.querySelector(`[name$="_wastage_percent"]`).value) || 0;
        const serviceRate = parseFloat(row.querySelector(`[name$="_service_rate"]`).value) || 0;

        const converted24k = (karate / 24) * weight;
        const wastageWeight = (wastagePercent * converted24k) / 100;
        const totalWeight24k = converted24k + wastageWeight;
        const serviceAmount = serviceRate * weight;
        const cashReceived = serviceAmount;

        row.querySelector(`[name$="_converted"]`).value = converted24k.toFixed(2);
        row.querySelector(`[name$="_wastage_weight"]`).value = wastageWeight.toFixed(2);
        row.querySelector(`[name$="_total_24k"]`).value = totalWeight24k.toFixed(2);
        row.querySelector(`[name$="_gold_received"]`).value = totalWeight24k.toFixed(2);
        row.querySelector(`[name$="_service_amount"]`).value = serviceAmount.toFixed(2);
        row.querySelector(`[name$="_cash_received"]`).value = cashReceived.toFixed(2);
    }

    document.getElementById('karate').addEventListener('input', () => {
        document.querySelectorAll('#casting-details-table tbody tr').forEach(recalculateRow);
    });

    // Handle select2
    $('.select2').select2().on('change', function () {
    const tableBody = document.querySelector("#casting-details-table tbody");
    const selectedIds = Array.from(this.selectedOptions).map(opt => opt.value);
    const allRows = tableBody.querySelectorAll('tr');

    // REMOVE rows for unselected new castings (i.e. not existing-row)
    allRows.forEach(row => {
        const castingId = row.dataset.castingId;
        if (!selectedIds.includes(castingId) && !row.classList.contains("existing-row")) {
            row.remove();
        }
    });

    // ADD rows for newly selected castings
    selectedIds.forEach(id => {
        if (!tableBody.querySelector(`tr[data-casting-id="${id}"]`)) {
            const castingNo = this.querySelector(`option[value="${id}"]`).text;
            const row = document.createElement("tr");
            row.setAttribute("data-casting-id", id);
            row.innerHTML = `
                <td><input type="text" value="${castingNo}" class="form-control" readonly></td>
                <td><input type="text" name="casting_${id}_weight" class="form-control"></td>
                <td><input type="text" name="casting_${id}_converted" class="form-control"></td>
                <td><input type="text" name="casting_${id}_wastage_percent" class="form-control"></td>
                <td><input type="text" name="casting_${id}_wastage_weight" class="form-control"></td>
                <td><input type="text" name="casting_${id}_total_24k" class="form-control" readonly></td>
                <td><input type="text" name="casting_${id}_gold_received" class="form-control"></td>
                <td><input type="text" name="casting_${id}_service_rate" class="form-control"></td>
                <td><input type="text" name="casting_${id}_service_amount" class="form-control"></td>
                <td><input type="text" name="casting_${id}_cash_received" class="form-control"></td>
            `;
            tableBody.appendChild(row);
            bindRowEvents(row);
        }
    });
});


    // Bind recalc to existing rows
    document.querySelectorAll('.existing-row').forEach(bindRowEvents);
</script>
{% endblock %}
